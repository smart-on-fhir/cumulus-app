openapi: 3.0.3
info:
  title: Cumulus dashboard
  description: |-
    OpenAPI specification for the Cumulus dashboard backend

    Some useful links:
    - [GitHub Repository](https://github.com/smart-on-fhir/cumulus-app)
    - [Test Instance](https://smart-cumulus-test.herokuapp.com/)

  # termsOfService: http://swagger.io/terms/
  # contact:
  #  email: apiteam@swagger.io
  license:
   name: Apache 2.0
   url: http://www.apache.org/licenses/LICENSE-2.0.html
  version: 1.0.11
# externalDocs:
#   description: Find out more about Swagger
#   url: http://swagger.io
servers:
  - url: https://smart-cumulus-test.herokuapp.com/api
  - url: https://smart-cumulus-ucdavis.herokuapp.com/api
  - url: https://smart-cumulus-regi-e973987fb5b9.herokuapp.com/api
  - url: https://smart-cumulus-staging.herokuapp.com/api
  - url: https://smart-cumulus.herokuapp.com/api
security: 
- session_id: []

paths:

  # Tags -----------------------------------------------------------------------

  /tags:
    get:
      summary: Get all Tags
      operationId: getTags
      tags: 
        - Tags
      description: |-
        Typically used to retrieve all tags at once but some filters can be applied to restrict the returned results.

        The current user is required to have `Tags.read` permission, or or multiple explicit permissions to read every single tag record (`Tags#1.read`, `Tags#2.read`, etc.)
      parameters:
        - $ref: '#/components/parameters/where'
        - $ref: '#/components/parameters/attributes'
        - $ref: '#/components/parameters/pick'
        - $ref: '#/components/parameters/omit'
        - $ref: '#/components/parameters/include'
        - $ref: '#/components/parameters/order'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
      responses: 
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Tag'
        '401':
          description: If the user is not authorized and guest users are not allowed to view tags
        '403':
          description: If the user is not allowed to view tags
        '400':
          description: Bad request due to invalid parameters
    post:
      summary: Creates new Tag
      operationId: createTag
      tags: 
        - Tags
      requestBody: 
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 50
                description:
                  type: string
                  minLength: 1
                  maxLength: 200
      responses:
        '200':
          description: Returns the created Tag object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
        '400':
          description: In case of invalid parameters
        '401':
          description: If the user is not authorized and guest users are not allowed to create tags
        '403':
          description: If the user is not allowed to create tags
  
  /tags/{id}:
    get:
      summary: Get Tag by ID
      operationId: getTag
      tags: 
        - Tags
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
        - name: creator
          in: query
          required: false
          description: If provided, includes the id and the email of the user who created this tag
          schema:
            type: boolean
        - name: graphs
          in: query
          required: false
          description: If provided, includes the graphs using this tag. Note that only the `id`, `name`, `description`, and `subscriptionId` fields of graphs are included.
          schema:
            type: boolean
        - name: subscriptions
          in: query
          required: false
          description: If provided, includes the subscriptions using this tag. Note that only the `id`, `name`, `description`, `completed`, and `refresh` subscription fields are included.
          schema:
            type: boolean
      responses:
        '200':
          description: Returns the requested Tag object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
        '400':
          description: In case of invalid parameters
        '401':
          description: If the user is not authorized and guest users are not allowed to view this model instance
        '403':
          description: If the user is not allowed to view this model instance
        '404':
          description: If the id cannot be found in the database
    put:
      summary: Update Tag
      operationId: updateTag
      tags: 
        - Tags
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
      requestBody: 
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 50
                description:
                  type: string
                  minLength: 1
                  maxLength: 200
      responses:
        '200':
          description: Returns the updated Tag object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
        '400':
          description: In case of invalid parameters
        '401':
          description: If the user is not authorized and guest users are not allowed to view or update this model instance
        '403':
          description: If the user is not allowed to view or update this model instance
        '404':
          description: If the id cannot be found in the database
    delete:
      summary: Delete Tag by ID
      operationId: deleteTag
      tags: 
        - Tags
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
      responses:
        '200':
          description: Returns the Tag object that was deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
        '401':
          description: If the user is not authorized and guest users are not allowed to delete tags
        '403':
          description: If the user is not allowed to delete tags
        '404':
          description: If the id cannot be found in the database

  # DataSites ------------------------------------------------------------------

  /data-sites:
    get:
      summary: Get all DataSites
      operationId: getDataSites
      tags: 
        - DataSites
      description: |-
        Typically used to retrieve all sites at once but some filters can be applied to restrict the returned results.

        The current user is required to have `DataSites.read` permission, or or multiple explicit permissions to read every single DataSites record (`DataSites#1.read`, `DataSites#2.read`, etc.)
      parameters:
        - $ref: '#/components/parameters/where'
        - $ref: '#/components/parameters/attributes'
        - $ref: '#/components/parameters/pick'
        - $ref: '#/components/parameters/omit'
        - $ref: '#/components/parameters/include'
        - $ref: '#/components/parameters/order'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
      responses: 
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DataSite'
        '401':
          description: If the user is not authorized and guest users are not allowed to view DataSites
        '403':
          description: If the user is not allowed to view DataSites
        '400':
          description: Bad request due to invalid parameters
    post:
      summary: Create new DataSite
      operationId: createDataSite
      tags: 
        - DataSites
      requestBody: 
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  $ref: '#/components/schemas/standardName'
                description:
                  $ref: '#/components/schemas/standardDescription'
      responses:
        '200':
          description: Returns the created DataSite object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataSite'
        '400':
          description: In case of invalid parameters
        '401':
          description: If the user is not authorized and guest users are not allowed to create DataSites
        '403':
          description: If the user is not allowed to create DataSites

  /data-sites/{id}:
    get:
      summary: Get DataSite by ID
      operationId: getDataSite
      tags: 
        - DataSites
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
      responses:
        '200':
          description: Returns the requested DataSite object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataSite'
        '400':
          description: In case of invalid parameters
        '401':
          description: If the user is not authorized and guest users are not allowed to view this model instance
        '403':
          description: If the user is not allowed to view this model instance
        '404':
          description: If the given id cannot be found in the database
    put:
      summary: Update DataSite
      operationId: updateDataSite
      tags: 
        - DataSites
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
      requestBody: 
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  $ref: '#/components/schemas/standardName'
                description:
                  $ref: '#/components/schemas/standardDescription'
                lat:
                  type: integer
                  description: Latitude
                  minimum: 0
                  maximum: 90
                long:
                  type: integer
                  description: Longitude
                  minimum: -180
                  maximum: 180
      responses:
        '200':
          description: Returns the updated DataSite object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataSite'
        '400':
          description: In case of invalid parameters
        '401':
          description: If the user is not authorized and guest users are not allowed to view or update this model instance
        '403':
          description: If the user is not allowed to view or update this model instance
        '404':
          description: If the id cannot be found in the database
    delete:
      summary: Delete DataSite by ID
      operationId: deleteDataSite
      tags: 
        - DataSites
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
      responses:
        '200':
          description: Returns the DataSite object that was deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataSite'
        '401':
          description: If the user is not authorized and guest users are not allowed to delete DataSites
        '403':
          description: If the user is not allowed to delete DataSites
        '404':
          description: If the id cannot be found in the database

  # Users ----------------------------------------------------------------------

  /users:
    get:
      summary: Get all Users
      operationId: getUsers
      tags: 
        - Users
      description: Note that some attributes of users (like sid and password) are excluded for security reasons
      responses: 
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        '400':
          description: If the client attempts to use the `where` or `include` parameters
        '401':
          description: If the user is not authorized and guest users are not allowed to view Users
        '403':
          description: If the user is not allowed to view Users

  /users/invite:
    post:
      summary: Invite new user
      operationId: inviteUser
      tags:
        - Users
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                role:
                  type: string
                  enum: 
                    - user
                    - manager
                    - admin
      responses:
        '200':
          description: User invited
          content:
            application/json:
              example: 
                message: "User invited"
        '401':
          description: Guest cannot invite users
        '403':
          description: User has no permission to invite others
        '400':
          description: User already invited, or invalid body parameters
        '500':
          description: Failed to invite user

  /users/me:
    get:
      summary: Current user info
      description: Get info about the current user (even if it is a guest, i.e. not logged in)
      operationId: getMyInfo
      tags: 
        - Users
      responses: 
        '200':
          description: Returns the current user augmented with `permissions` property which is an
            array of permissions granted to this user
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/User'
                  - type: object
                    properties:
                      permissions:
                        $ref: '#/components/schemas/permissionList'
        '400':
          description: Unexpected error
    put:
      summary: Update my Account
      description: Update the account of the current user
      operationId: updateMyInfo
      tags:
        - Users
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                password:
                  type: string
                newPassword1:
                  type: string
                newPassword2:
                  type: string
                name:
                  type: string
      responses:
        '200':
          description: Successful update
          content:
            application/json:
              example:
                email: email@example.com,
                name: userDisplayName,
                role: user
        '400':
          description: Error updating account
        '403':
          description: Invalid password
        '404':
          description: User not found

  /users/reset:
    post:
      summary: Initiate Password Reset
      description: |-
        - The user enters an `email` and submits a POST form to this endpoint
        - An email with reset link is sent to the given email
        - Only users having access to the given email can complete the reset flow
        - An attacker might be tempted to brute-force this endpoint trying to discover
          what emails are registered in our DB, To discourage that we enforce one
          second delay!
      operationId: initiatePasswordReset
      tags: 
        - Users
      security: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Password reset email sent
          content:
            text/plain:
              example: Pending activation
              schema:
                type: string
        '400':
          description: No user found using this email
        '500':
          description: If we can't send the email
  
  /users/update-password:
    post:
      summary: Complete Password Reset
      operationId: completePasswordReset
      description: The user receives a password reset email with link pointing to
        an HTML form and containing an unique reset code that expires after a while.
        Then they have a chance to enter new password and submit to this route.
      tags: 
        - Users
      security: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                code:
                  type: string
                  example: 062ec1a1fcdcef0a048702d63fe5b2ef3810bf50acb2d32a694e198ac803455a
                password:
                  type: string
                  example: myNew-password2345
      responses:
        '200':
          description: Password updated
          content:
            text/plain:
              example: Password updated
              schema:
                type: string
        '400':
          description: Invalid password reset code or error updating account
        '410':
          description: Expired password reset link

  /users/{id}:
    get:
      summary: Get User by ID
      operationId: getUser
      tags: 
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
      responses:
        '200':
          description: Returns the requested User object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: If the user is not authorized and guest users are not allowed to view this model instance
        '403':
          description: If the user is not allowed to view this model instance
        '404':
          description: If the id cannot be found in the database
    put:
      summary: Update User
      operationId: updateUser
      description: |-
        Updates the user with the specified ID. **NOTE:** for security reasons most fields cannot
        be updated and are **ignored**! The only properties you can update are `name` (user's display name) and `role`.
      tags: 
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  maxLength: 100
                  example: User display name
                role:
                  type: string
                  enum: 
                    - user
                    - manager
                    - admin
                
      responses:
        '200':
          description: Returns the updated DataSite object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: In case of invalid parameters
        '401':
          description: If the user is not authorized and guest users are not allowed to view or update this model instance
        '403':
          description: If the user is not allowed to view or update this model instance
        '404':
          description: If the id cannot be found in the database
    delete:
      summary: Delete User by ID
      operationId: deleteUser
      tags: 
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
      responses:
        '200':
          description: Returns the User object that was deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: If the user is not authorized and guest users are not allowed to delete Users
        '403':
          description: If the user is not allowed to delete Users
        '404':
          description: If the id cannot be found in the database

  /users/activate:
    post:
      summary: Activate account
      description: Invited users fill a form to complete and activate their
        account. The form submits to this endpoint anf is the activation is
        successful, the user can proceed to login and start using the dashboard.
      operationId: activateAccount
      security: []
      tags:
        - Users
      responses:
        '200':
          description: Successful activation
          content:
            application/json:
              example: 
                name: User display name
        '400':
          description: Passwords do not match, bad parameters, or error activating account
        '404':
          description: Invalid or expired invitation
        '409':
          description: Account already activated
        '410':
          description: Expired invitation
  /users/activate/{code}:
    get:
      summary: Check activation status
      description: When an user is invited, they receive an invitation email. It
        contains a link that points to activation form. When this form is loaded
        we use this endpoint to check for errors with this activation link and the
        code that is contains.
      operationId: checkUserActivationStatus
      security: []
      tags: 
        - Users
      parameters:
        - name: code
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Pending activation
          content:
            text/plain:
              example: Pending activation
        '400':
          description: Missing code parameter
        '404':
          description: Invalid or expired invitation
        '409':
          description: Account already activated
        '410':
          description: Expired invitation
  
  # Auth -----------------------------------------------------------------------

  /auth/login:
    post:
      summary: login
      description: |-
        Here is all this does in order:
        - Looks for a user with the given `email` (although the parameter is called `username`)
        - If the user is not found replies with "Invalid email or password" error. The real reason can be seen in STDERR, but is not sent to the client.
        - Checks the password. If invalid, exits with an error error same as above.
        - Creates new session ID (sid)
        - Updates the user to have the new `sid` and the current date as `lastLogin`
        - Sets new cookie called `sid` and containing the session ID. If `remember` is set, the
          cookie will expire in one year. Otherwise, it is a session cookie. In both cases is
          has the `httpOnly` flag set to true so that it is read-only for the client.
        - Finally, replies with an object having some properties of the user, the `remember` value,
          and the list of granted permissions for that user.
      operationId: login
      security: []
      tags:
        - Auth
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  format: email
                  description: Note that this is still called `username` but is in fact the email of the user!
                password:
                  type: string
                  format: password
                  example: my#Password2345
                remember:
                  type: boolean
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              example:
                id: 2
                name: John Doe
                email: john.doe@example.com
                role: user
                remember: true
                permissions:
                  - Views.read
                  - Tags.read
                  - ...
        '400':
          description: Invalid email or password
        '401':
          description: Login failed
  /auth/logout:
    get:
      summary: logout
      description: If the user is currently logged in, then updates it to clear
        the `sid` and clears the `sid` cookie. For security reasons we enforce
        one second delay to this operation.
      tags:
        - Auth
      operationId: logout
      security: []
      responses:
        '200':
          description: Successful logout
          content:
            application/json:
              example:
                message: "Logged out"
        '400':
          description: Unexpected error

  # Study Areas ----------------------------------------------------------------
  /projects:
    get:
      summary: Get All Study Areas
      operationId: getStudyAreas
      tags: 
        - Study Areas
      description: |-
        Typically used to retrieve all study areas at once but some filters can
        be applied to restrict the returned results.

        **Note** that the response will always include the subscriptions of each
        study area and the views of each subscription.

      parameters:
        - $ref: '#/components/parameters/where'
        - $ref: '#/components/parameters/attributes'
        # - $ref: '#/components/parameters/pick'
        # - $ref: '#/components/parameters/omit'
        # - $ref: '#/components/parameters/include'
        - $ref: '#/components/parameters/order'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              example:
                id: 1
                name: Example Study Area
                description: Example Study Area Description
                creatorId: 2
                createdAt: 2024-02-22T13:36:17.315Z
                updatedAt: 2024-02-22T13:36:17.315Z
                Subscriptions: []
        '401':
          description: If the user is not authorized and guest users are not
            allowed to view included resources
        '403':
          description: If the user is not allowed to view included resources
        '400':
          description: Bad request due to invalid parameters

  # Views ----------------------------------------------------------------------
  /views:
    get:
      summary: Get All Views
      description: Retrieve an array of all the views that the current user 
        is allowed to see
      operationId: getViews
      tags: 
        - Views
      parameters:
        - $ref: '#/components/parameters/order'
        - name: limit
          in: query
          schema:
            type: integer
          example: 10
          required: false
          allowEmptyValue: true
        - $ref: '#/components/parameters/offset'
        - $ref: '#/components/parameters/attributes'
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  allOf:
                    - $ref: '#/components/schemas/View'
                    - type: object
                      properties:
                        Tags:
                          type: array
                          items:
                            type: object
                            properties:
                              id:
                                $ref: '#/components/schemas/standardID'
                              name:
                                type: string
                                maxLength: 50
                              description:
                                type: string
                                maxLength: 200
                        DataRequest:
                          type: object
                          properties:
                            id:
                              $ref: '#/components/schemas/standardID'
                            name:
                              type: string
                              maxLength: 100
              example:
                - id: 1
                  name: Example View
                  description: Example View Description
                  screenShot: Base 64 image data...
                  settings: {}
                  subscriptionId: 1
                  creatorId: 2
                  createdAt: 2024-02-22T13:36:17.315Z
                  updatedAt: 2024-02-22T13:36:17.315Z
                  Tags: []
                  DataRequest:
                    id: 1
                    name: Subscription Name
        '401':
          description: If the user is not authorized and guest users are not
            allowed to view included resources
        '403':
          description: If the user is not allowed to view included resources
        '400':
          description: Bad request due to invalid parameters
    post:
      summary: Create View
      description: Creates new View
      operationId: createView
      tags: 
        - Views
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  maxLength: 100
                  example: View display name
                description:
                  type: string
                  maxLength: 500
                  example: View description
                screenShot:
                  type: string
                  example: base64imageData...
                Tags:
                  type: array
                  items:
                    $ref: '#/components/schemas/Tag'
                settings:
                  type: object
                subscriptionId:
                  type: integer
                  minimum: 1
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/View'
                  - type: object
                    properties:
                      Tags:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              $ref: '#/components/schemas/standardID'
                            name:
                              type: string
                              maxLength: 50
                            description:
                              type: string
                              maxLength: 200
                      DataRequest:
                        type: object
                        properties:
                          id:
                            $ref: '#/components/schemas/standardID'
                          name:
                            type: string
                            maxLength: 100
        '401':
          description: If the user is not authorized and guest users are not
            allowed to create views
        '403':
          description: If the user is not allowed to create views
        '400':
          description: Bad request due to invalid parameters
    delete:
      summary: Delete Multiple Views
      operationId: bulkDeleteView
      description: Deletes multiple Views
      tags: 
        - Views
      parameters:
        - name: id
          in: query
          required: true
          description: Comma-separated list of IDs to delete
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              example:
                message: Deleted 5 graphs
        '401':
          description: If the user is not authorized and guest users are not
            allowed to delete included resources
        '403':
          description: If the user is not allowed to delete included resources
        '400':
          description: Bad request due to invalid parameters

  /views/{id}:
    get:
      summary: Get View by ID
      operationId: getView
      tags: 
        - Views
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
        - name: tags
          in: query
          required: false
          description: If set include related tags with id, name and description
          schema:
            type: boolean
        - name: subscription
          in: query
          required: false
          description: If set include the subscription
          schema:
            type: boolean
        - name: group
          in: query
          required: false
          description: If set include the subscription and its group
          schema:
            type: boolean
        - name: projects
          in: query
          required: false
          description: If set include the subscription and its projects
          schema:
            type: boolean
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/View'
                  - type: object
                    properties:
                      Tags:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              $ref: '#/components/schemas/standardID'
                            name:
                              type: string
                              maxLength: 50
                            description:
                              type: string
                              maxLength: 200
                      DataRequest:
                        type: object
                        properties:
                          id:
                            $ref: '#/components/schemas/standardID'
                          name:
                            type: string
                            maxLength: 100
                      group:
                        $ref: '#/components/schemas/SubscriptionGroup'
                      Projects:
                        type: array
                        items:
                          $ref: '#/components/schemas/StudyArea'

              example:
                id: 1
                name: Example View
                description: Example View Description
                screenShot: Base 64 image data...
                settings: {}
                subscriptionId: 1
                creatorId: 2
                createdAt: 2024-02-22T13:36:17.315Z
                updatedAt: 2024-02-22T13:36:17.315Z
                Tags:
                  - id: 1
                    name: Tag 1
                    description: Tag 1 description
                DataRequest:
                  id: 1
                  name: Subscription Name
                group:
                  id: 1
                  name: Group 1
                  description: Group 1 description
                  createdAt: 2024-02-22T13:36:17.315Z
                  updatedAt: 2024-02-22T13:36:17.315Z
                Projects: []

        '401':
          description: If the user is not authorized and guest users are not
            allowed to view included resources
        '403':
          description: If the user is not allowed to view included resources
        '400':
          description: Bad request due to invalid parameters
        '404':
          description: View not found
    put:
      summary: Update a View
      operationId: updateView
      description: |-
        Updates a View
        - The payload is a partial View object
        - Payload properties like `id`, `subscriptionId`, `createdAt` and
          `updatedAt` are ignored.
        - If `Tags` array is provided, it can contain partial tag objects but
          we only need/use their `id` property.
      tags: 
        - Views
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  maxLength: 100
                  example: View display name
                description:
                  type: string
                  maxLength: 500
                  example: View description
                screenShot:
                  type: string
                  example: base64imageData...
                Tags:
                  type: array
                  items:
                    $ref: '#/components/schemas/Tag'
                settings:
                  type: object
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/View'
        '401':
          description: If the user is not authorized and guest users are not
            allowed to update included resources
        '403':
          description: If the user is not allowed to update included resources
        '400':
          description: Bad request due to invalid parameters
        '500':
          description: Updating graph failed
    delete:
      summary: Delete a View
      operationId: deleteView
      description: Deletes a View
      tags: 
        - Views
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/View'
        '401':
          description: If the user is not authorized and guest users are not
            allowed to delete included resources
        '403':
          description: If the user is not allowed to delete included resources
        '400':
          description: Deleting failed
        '404':
          description: No View with this ID found

  /views/{id}/screenshot:
    get:
      summary: Get View Screenshot
      description: View have thumbnail images stored as base64 image data. If
        such data exists then convert it to an image file and serve it with
        proper caching headers. Otherwise serve the default view icon file.
      operationId: getViewScreenshot
      tags: 
        - Views
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
      responses:
        '200':
          description: successful operation
          headers:
            Cache-Control:
              description: Disable caching
              schema:
                type: string
                example: max-age=31536000, no-cache
            Vary:
              description: Control caching using ETag
              schema:
                type: string
                example: Origin, ETag
            ETag:
              description: ETag for this image
              schema:
                type: string
            Content-Type:
              description: Image mime type
              schema:
                type: string
            Content-Length:
              description: Image byte size
              schema:
                type: integer
          content:
            image/png:
              schema:
                type: string
              example: BINARY IMAGE DATA

        '304':
          description: If the client provides a `if-none-match` header matching
            the current ETag of the image
        '400':
          description: Invalid base64 image data
        '401':
          description: If the user is not authorized and guest users are not
            allowed to view included resources
        '403':
          description: If the user is not allowed to view included resources
        '404':
          description: View not found

  /views/{id}/request-linelevel-data:
    post:
      summary: Request Linelevel Data
      description: This is not fully implemented yet. It will either change, or
        will be removed in the future
      deprecated: true
      operationId: requestLinelevelData
      tags: 
        - Views
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/standardID'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                subscription:
                  type: object
                  properties:
                    id:
                      type: integer
                    name:
                      type: string
                view:
                  type: object
                  properties:
                    id:
                      type: integer
                    name:
                      type: string
                type:
                  type: string
                  enum:
                    - required
                    - preferred
                    - optional
                reason:
                  type: string
                user:
                  type: object
                  properties:
                    username:
                      type: string
                dataElements:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                      need:
                        type: string
      responses:
        '200':
          description: Returns empty response on success
        '401':
          description: If the user is not authorized and guest users are not
            allowed to request linelevel data
        '403':
          description: If the user is not allowed to request linelevel data
        '400':
          description: Bad request due to invalid parameters
        # '404':
        #   description: View not found

components:
  parameters:
    where:
      name: where
      in: query
      schema:
        type: string
      description: |-
        Can contain zero or more comma-separated where conditions.
        
        #### *Examples*:
        - ***name:value** pairs - `name:John`*
        - ***name:operator:value** - `age:lt:10`*
        - ***multiple conditions** - `name:John,age:gt:5`*
      required: false
      allowEmptyValue: true
    attributes:
      name: attributes
      in: query
      schema:
        type: string
      description: |-
        Comma-separated list of model attributes to include in the response

        ***Example**: `id, name, age`*
      required: false
      allowEmptyValue: true
    pick:
      name: pick
      in: query
      schema:
        type: string
      description: |-
        Comma-separated list of model attributes to include in the response.
        
        **NOTE:** This parameter is ignored when the `attributes` parameter is used

        ***Example**: `id, name, age`*
      required: false
      allowEmptyValue: true
    omit:
      name: omit
      in: query
      schema:
        type: string
      description: |-
        Comma-separated list of model attributes to exclude from the response.
        
        **NOTE:** This parameter is ignored when the `attributes` parameter is used

        ***Example**: `id, name, age`*
      required: false
      allowEmptyValue: true
    include:
      name: include
      in: query
      schema:
        type: string
      description: |-
        Comma-separated list of associations to include. Each item in the list can be:
        
        ***Examples**:*
        - *`model` - The name of the model to include*
        - *`model:attribute1|attribute2...` - Specify what attributes to include for each model*
        - *`model:attribute1:alias1|attribute2...` - Can also specify aliases for included attributes*
      required: false
      allowEmptyValue: true
    order:
      name: order
      in: query
      schema: 
        type: string
      description: |-
        Sorting instruction(s)

        ***Example**: `name:ask,age:desc`*
      required: false
      allowEmptyValue: true
    limit:
      name: limit
      in: query
      schema:
        type: string
      description: |-
        limit or limits for each included model

        ***Examples**:*
        - Basic limit: `10`
        - Also specify limits for included models: `10,Users:30`
      required: false
      allowEmptyValue: true
    offset:
      name: offset
      in: query
      description: How many records to skip
      required: false
      allowEmptyValue: true
      schema: 
        type: integer

  schemas:
    standardID:
      type: integer
      format: int64
      minimum: 1
    standardName:
      type: string
    standardDescription:
      type: string
    autoTimestamp:
      type: string
      format: date-time
    permissionList:
      type: array
      items:
        type: string

    Tag:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/standardID'
        name:
          $ref: '#/components/schemas/standardName'
        description:
          $ref: '#/components/schemas/standardDescription'
        creatorId:
          $ref: '#/components/schemas/standardID'
        createdAt:
          $ref: '#/components/schemas/autoTimestamp'
        updatedAt:
          $ref: '#/components/schemas/autoTimestamp'
    DataSite:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/standardID'
        name:
          $ref: '#/components/schemas/standardName'
        description:
          $ref: '#/components/schemas/standardDescription'
        lat:
          type: integer
          format: int64
        long:
          type: integer
          format: int64
        createdAt:
          $ref: '#/components/schemas/autoTimestamp'
        updatedAt:
          $ref: '#/components/schemas/autoTimestamp'
    User:
      type: object
      properties: 
        id:
            $ref: '#/components/schemas/standardID'
        name:
          type: string
          maxLength: 100
        email:
          type: string
          maxLength: 100
          format: email
        role:
          type: string
          enum: 
            - user
            - manager
            - admin
        # password:
          # type: string
        # sid:
          # type: string
        lastLogin:
          type: string
          format: date-time
        activationCode:
          type: string
          minLength: 32
          maxLength: 32
        invitedBy:
          $ref: '#/components/schemas/standardID'
        status:
          type: string
          enum:
            - Logged in
            - Not logged in
            - Never logged in
            - Expired invitation
            - Pending invitation
        activateUntil:
          type: string
          format: date-time
        createdAt:
          $ref: '#/components/schemas/autoTimestamp'
        updatedAt:
          $ref: '#/components/schemas/autoTimestamp'
    
    StudyArea:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/standardID'
        name:
          type: string
          maxLength: 100
        description:
          type: string
        creatorId:
          type: integer
          minimum: 1
          nullable: true
        createdAt:
          $ref: '#/components/schemas/autoTimestamp'
        updatedAt:
          $ref: '#/components/schemas/autoTimestamp'
      
    Subscription:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/standardID'
        name:
          type: string
          maxLength: 100
        description:
          type: string
          nullable: true
        refresh:
          type: string
          enum:
            - manually
            - yearly
            - monthly
            - weekly
            - daily
        completed:
          type: string
          format: date-time
          nullable: true
        requestedData:
          type: object
          nullable: true
        metadata:
          type: object
          nullable: true
        groupId:
          type: integer
          minimum: 1
          nullable: true
        dataURL:
          type: string
          nullable: true
        transmissions:
          type: object
          nullable: true
        createdAt:
          $ref: '#/components/schemas/autoTimestamp'
        updatedAt:
          $ref: '#/components/schemas/autoTimestamp'

    SubscriptionGroup:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/standardID'
        name:
          type: string
        description:
          type: string
          nullable: true
        createdAt:
          $ref: '#/components/schemas/autoTimestamp'
        updatedAt:
          $ref: '#/components/schemas/autoTimestamp'


    View:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/standardID'
        name:
          type: string
          maxLength: 100
        description:
          type: string
          maxLength: 500
          nullable: true
        screenShot:
          type: string
          nullable: true
        settings:
          type: object
        subscriptionId:
          $ref: '#/components/schemas/standardID'
        creatorId:
          $ref: '#/components/schemas/standardID'
        createdAt:
          $ref: '#/components/schemas/autoTimestamp'
        updatedAt:
          $ref: '#/components/schemas/autoTimestamp'
  
  securitySchemes:
    session_id:
      type: apiKey
      name: sid
      in: cookie